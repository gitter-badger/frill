<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/server.js | FrillJS API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/nanopx/frill" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/core/Action.js~Action.html">Action</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/core/Context.js~Context.html">Context</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/core/Dispatcher.js~Dispatcher.html">Dispatcher</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/core/Store.js~Store.html">Store</a></span></li>
</ul>
</div>





<div data-ice="variableWrap">
  <h2><a href="variable/">Variable</a></h2>
  <ul>
    
  <li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-action">action</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-apiPlugin">apiPlugin</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-context">context</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-store">store</a></span></li>
</ul>
</div>




</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">global.__SERVER__ = true;

import Frill from &apos;./bootstrap&apos;;
import pack from &apos;../package&apos;;
import apiPlugin from &apos;./api&apos;;
import routes from &apos;./routes&apos;;
import Hapi from &apos;hapi&apos;;
import React from &apos;react&apos;;
import Router from &apos;react-router&apos;;
import Redis from &apos;catbox-redis&apos;;
import Jade from &apos;jade&apos;;
import good from &apos;good&apos;;
import goodConsole from &apos;good-console&apos;;
import swagger from &apos;hapi-swagger&apos;;
import _extend from &apos;lodash/object/extend&apos;;
import _isUndefined from &apos;lodash/lang/isUndefined&apos;;
import _argv from &apos;minimist&apos;;
let argv = _argv;
argv = _argv(process.argv.slice(2));

/**
 * Configure hapi.
 */
const SERVER_PORT = 3000;
const server = new Hapi.Server({
  cache: [{
    name: &apos;redis&apos;,
    engine: Redis,
    host: &apos;127.0.0.1&apos;,
    // partition: &apos;cache&apos;,
  }]
});
server.connection({port: SERVER_PORT});

/**
 * Configure hapi views
 */
server.views({
  engines: {
    jade: Jade
  },
  relativeTo: __dirname,
  path: &apos;templates&apos;,
});

/**
 * Attempt to serve static files
 */
server.route({
	method:  &apos;*&apos;,
	path:    &apos;/{params*}&apos;,
	handler: (request, reply) =&gt; {
		reply.file(&apos;public&apos; + request.path);
	}
});

/**
 * Mount all the APIs to hapi
 */
server.register({
  register: apiPlugin,
}, {
  routes: {
    prefix: &apos;/api&apos;,
  }
}, (err) =&gt; {
  if (err) server.log([&apos;error&apos;], `API plugin load error: ${err}`);
});

/**
 * Configure hapi-swagger for API documentation.
 */
const swaggerOptions = {
  apiVersion: pack.version,
  basePath: &apos;http://localhost:3001&apos;,
};

server.register({
  register: swagger,
  options: swaggerOptions
}, (err) =&gt; {
  if (err) server.log([&apos;error&apos;], `hapi-swagger load error: ${err}`);
});

/**
 * Catch requests to fire React Router
 */

// create context
const frillContext = Frill.attach(Frill._Stores, Frill._Actions);

server.ext(&apos;onPreResponse&apos;, (request, reply) =&gt; {
	if (!_isUndefined(request.response.statusCode)) {
		return reply.continue();
	}
  // fire React Router
  server.log([&apos;info&apos;], `Serving down to react-router with ${request.path}`);
  Router.run(routes(), request.path, (Handler, state) =&gt; {
    // pass down frill context to handler
    const patchedState = _extend({frill: frillContext}, state);
    const handler = React.createElement(Handler, patchedState);
    const markup = React.renderToString(handler);
    server.log([&apos;verbose&apos;], markup);
    reply.view(&apos;default&apos;, {
      initialData: JSON.stringify(state),
      markup: markup
    });
  });
});

// define which log level outputs which tags
const logLevels = {
  silent: {},
  error: {
    error: &apos;*&apos;,
    log: [&apos;error&apos;],
    response: [&apos;error&apos;],
  },
  debug: {
    error: &apos;*&apos;,
    log: [&apos;debug&apos;, &apos;error&apos;],
    response: [&apos;debug&apos;, &apos;error&apos;],
  },
  info: {
    error: &apos;*&apos;,
    log: [&apos;info&apos;, &apos;debug&apos;, &apos;error&apos;],
    response: [&apos;info&apos;, &apos;debug&apos;, &apos;error&apos;],
  },
  verbose: {
    log: &apos;*&apos;,
    ops: &apos;*&apos;,
    error: &apos;*&apos;,
    request: &apos;*&apos;,
    response: &apos;*&apos;,
  },
};

let logEvents;
if (argv.verbose) {
  logEvents = logLevels.verbose;
} else if (argv.info) {
  logEvents = logLevels.info;
} else if (argv.debug) {
  logEvents = logLevels.debug;
} else if (argv.error) {
  logEvents = logLevels.error;
} else if (argv.silent) {
  logEvents = logLevels.silent;
} else {
  logEvents = logLevels.info;
}

/**
 * Configure good (for logging hapi)
 */
const goodOptions = {
  reporters: [{
      reporter: goodConsole,
      events: logEvents,
      config: {
        format: &apos;[[]HH:mm:ss[]][[frill]]&apos;,
        utc: false
      }
  }],
};

server.register({
  register: good,
  options: goodOptions
}, (err) =&gt; {
  if (err) {
    console.error(err);
  } else {
    // initialize server
    server.start(() =&gt; server.log([&apos;info&apos;], `Server started at ${server.info.uri}`));
  }
});
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.1.4)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
