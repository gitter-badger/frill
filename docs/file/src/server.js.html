<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/server.js | FrillJS API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/nanopx/frill" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/components/App/index.jsx~AppComponent.html">AppComponent</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/actions/Auth.js~AuthAction.html">AuthAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/stores/Auth.js~AuthStore.html">AuthStore</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/components/Error.jsx~ErrorComponent.html">ErrorComponent</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/actions/Example.js~ExampleAction.html">ExampleAction</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/stores/Example.js~ExampleStore.html">ExampleStore</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/components/Login/index.jsx~LoginComponent.html">LoginComponent</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/components/Page.jsx~PageComponent.html">PageComponent</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/components/ScrollBlock/index.jsx~ScrollBlockComponent.html">ScrollBlockComponent</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/components/Top/index.jsx~TopComponent.html">TopComponent</a></span></li>
</ul>
</div>





<div data-ice="variableWrap">
  <h2><a href="variable/">Variable</a></h2>
  <ul>
    
  <li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-Actions">Actions</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-Components">Components</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-FrillCore">FrillCore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-Models">Models</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-Stores">Stores</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-Strategies">Strategies</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-api">api</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-apiV1">apiV1</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-apiV1Hello">apiV1Hello</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-appComponent">appComponent</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-authAction">authAction</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-authHandlers">authHandlers</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-authRoutes">authRoutes</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-authStore">authStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-componentRoutes">componentRoutes</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-errorComponent">errorComponent</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-exampleAction">exampleAction</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-exampleStore">exampleStore</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-facebookStrategy">facebookStrategy</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-githubStrategy">githubStrategy</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-googleStrategy">googleStrategy</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-helpers">helpers</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-jwtStrategy">jwtStrategy</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-localAuthRoutes">localAuthRoutes</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-localAuthRoutes">localAuthRoutes</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-localStrategy">localStrategy</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-loginComponent">loginComponent</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-pageComponent">pageComponent</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-posts">posts</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-routePrefixer">routePrefixer</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-routerContainer">routerContainer</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-routes">routes</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-scrollBlockComponent">scrollBlockComponent</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-topComponent">topComponent</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-twitterAuthRoutes">twitterAuthRoutes</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-twitterStrategy">twitterStrategy</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-users">users</a></span></li>
</ul>
</div>



<div data-ice="externalWrap">
  <h2>External</h2>
  <ul>
    
  <li data-ice="externalDoc"><span><a href="http://aws.amazon.com/">AmazonWebServices</a></span></li>
<li data-ice="externalDoc"><span><a href="http://docs.sequelizejs.com/en/latest">Sequelize</a></span></li>
<li data-ice="externalDoc"><span><a href="https://github.com/ryanfitz/vogels">Vogels</a></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">import Frill from &apos;./bootstrap&apos;;
import pack from &apos;../package&apos;;
import api from &apos;./api&apos;;
import routes from &apos;./routes&apos;;
import Hapi from &apos;hapi&apos;;
import React from &apos;react&apos;;
import Router from &apos;react-router&apos;;
import Redis from &apos;catbox-redis&apos;;
import Session from &apos;yar&apos;;
import Authentication from &apos;bell&apos;;
import Jade from &apos;jade&apos;;
import good from &apos;good&apos;;
import goodConsole from &apos;good-console&apos;;
import swagger from &apos;hapi-swagger&apos;;
import _find from &apos;lodash/collection/find&apos;;
import _extend from &apos;lodash/object/extend&apos;;
import _isUndefined from &apos;lodash/lang/isUndefined&apos;;
import _argv from &apos;minimist&apos;;
let argv = _argv;
argv = _argv(process.argv.slice(2));

/**
 * Configure hapi.
 */
const SERVER_PORT = 3000;
const server = new Hapi.Server({
  cache: [{
    name: &apos;redis&apos;,
    engine: Redis,
    host: &apos;127.0.0.1&apos;,
    // partition: &apos;cache&apos;,
  }],
});
server.connection({port: SERVER_PORT});

/**
 * Configure sessions
 */
server.register({
  register: Session,
  options: {
    maxCookieSize: 0,
    cookieOptions: {
      password: &apos;SOME_PASSWORD&apos;, /** @todo send options to a config */
      isSecure: false, /** @todo cannot do this at production */
    },
  },
}, (err) =&gt; {
  if (err) server.log([&apos;error&apos;], `session load error: ${err}`);
});

/**
 * Configure authentication strategies
 */
server.register([
  Authentication,
], (err) =&gt; {
  if (err) server.log([&apos;error&apos;], `authentication load error: ${err}`);
});

/**
 * Configure hapi views
 */
server.views({
  engines: {
    jade: Jade,
  },
  relativeTo: __dirname,
  path: &apos;templates&apos;,
});

/**
 * Attempt to serve static files
 */
server.route({
  method: &apos;*&apos;,
  path: &apos;/{params*}&apos;,
  // don&apos;t use authentication strategy
  config: { auth: false },
  handler: (request, reply) =&gt; {
    if (request.path === &apos;/&apos;) {
      return reply.continue();
    }
    reply.file(&apos;public&apos; + request.path);
  },
});


/**
 * Mount all the APIs to hapi
 */
api(server);

/**
 * Configure hapi-swagger for API documentation.
 * @todo: disable at production
 */
const swaggerOptions = {
  apiVersion: pack.version,
  basePath: &apos;http://localhost:3001&apos;,
};

server.register({
  register: swagger,
  options: swaggerOptions,
}, (err) =&gt; {
  if (err) server.log([&apos;error&apos;], `hapi-swagger load error: ${err}`);
});

/**
 * Catch requests to fire React Router
 */
// create context
const frillContext = Frill.attach(Frill._Stores, Frill._Actions);

server.ext(&apos;onPreResponse&apos;, (request, reply) =&gt; {
  const response = request.response;

  // if API request
  if (response.isBoom &amp;&amp; request.path.substring(0, 5) === &apos;/api/&apos;) {
    return reply.continue();
  }

  // if status code exists and request.path set to &apos;/&apos;
  if (!_isUndefined(request.response.statusCode) &amp;&amp; request.path !== &apos;/&apos;) {
    return reply.continue();
  }

  // fire React Router
  server.log([&apos;info&apos;], `Serving down to react-router with ${request.path}`);

  Router.run(routes(), request.path, (Handler, state) =&gt; {
    // find route from request.path
    const isFoundRoute = _find(state.routes, { path: request.path });

    // 200 if route found, else 404
    const _status = isFoundRoute ? 200 : 404;

    // create temporary output status
    let status = { statusCode: _status, error: &apos;&apos;, message: &apos;&apos; };

    // if response is an Error
    if (response.isBoom &amp;&amp; response.output.statusCode !== 404) {
      status = response.output.payload;
    } else {
      if (_status === 200) {
        status.message = &apos;OK&apos;;
      } else if (_status === 404) {
        status.error = &apos;NotFound&apos;;
        status.message = &apos;Page not found.&apos;;
      }
    }

    // set status to state
    state.status = status;

    // set auth token if exists
    state.token = request.session.flash(&apos;token&apos;)[0];

    // pass down frill context to handler
    const patchedState = _extend({frill: frillContext}, state);

    // create handler
    const handler = React.createElement(Handler, patchedState);

    // construct markup
    const markup = React.renderToString(handler);

    server.log([&apos;verbose&apos;], markup);
    reply.view(&apos;default&apos;, {
      initialData: JSON.stringify(state),
      markup: markup,
    }).code(status.statusCode);
  });
});


/**
 * Configure good (for logging hapi)
 * TODO: disable at production
 */
// define which log level outputs which tags
const logLevels = {
  silent: {},
  error: {
    error: &apos;*&apos;,
    log: [&apos;error&apos;],
    response: [&apos;error&apos;],
  },
  debug: {
    error: &apos;*&apos;,
    log: [&apos;debug&apos;, &apos;error&apos;],
    response: [&apos;debug&apos;, &apos;error&apos;],
  },
  info: {
    error: &apos;*&apos;,
    log: [&apos;info&apos;, &apos;debug&apos;, &apos;error&apos;],
    response: [&apos;info&apos;, &apos;debug&apos;, &apos;error&apos;],
  },
  verbose: {
    log: &apos;*&apos;,
    ops: &apos;*&apos;,
    error: &apos;*&apos;,
    request: &apos;*&apos;,
    response: &apos;*&apos;,
  },
};

let logEvents;
if (argv.verbose) {
  logEvents = logLevels.verbose;
} else if (argv.info) {
  logEvents = logLevels.info;
} else if (argv.debug) {
  logEvents = logLevels.debug;
} else if (argv.error) {
  logEvents = logLevels.error;
} else if (argv.silent) {
  logEvents = logLevels.silent;
} else {
  logEvents = logLevels.info;
}

const goodOptions = {
  reporters: [{
    reporter: goodConsole,
    events: logEvents,
    config: {
      format: &apos;[[]HH:mm:ss[]][[frill]]&apos;,
      utc: false,
    },
  }],
};

server.register({
  register: good,
  options: goodOptions,
}, (err) =&gt; {
  if (err) {
    console.error(err);
  } else {
    // initialize server
    server.start(() =&gt; {
      server.log([&apos;info&apos;], `Server started at ${server.info.uri}`);
    });
  }
});
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.2.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
